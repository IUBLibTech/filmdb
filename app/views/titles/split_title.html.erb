<%= form_tag update_split_title_path do %>
<h4>Splitting <%= link_to @title.title_text, title_path(@title), class: 'orange' %></h4>
<p>Reassign Physical Objects in this Title by selecting their new titles in the title field below</p>
<table>
  <tbody>
  <tr>
    <th>IU Barcode</th>
    <th>Reassign to Title</th>
    <th></th>
  </tr>
  <% @title.physical_objects.each do |p| %>
  <tr>
    <td><%= p.iu_barcode %></td>
    <td id="po_<%= p.id %>"><%= text_field_tag "retitled[physical_objects[#{p.id}]]", nil, class: 'title_text', size: 50 %></td>
    <td><%= link_to "+", '#', remote: true, class: 'remove_button cg_button', id: "add_component_group#{p.id}", title: 'Click to add a Component Group to the new Title' %></td>
  </tr>
  <% end %>
  </tbody>
</table>
<% end %>
<div id="title_sum" style="top: 300px; right: 420px" >

</div>

<script type="text/javascript" charset="utf-8">
  // tracks retitled ids and maps them to the physical object ids being reassigned
  var title_map = {};
  $(document).ready(function() {
      $(".cg_button").hide();
      $('.title_text').autocomplete({
        minLength: 2,
        //source: '<%= autocomplete_title_path %>',
        source: function (request, response) {
            $.ajax({
                url: "<%= autocomplete_title_path %>",
                dataType: "json",
                data: {
                    term: request.term,
                    exclude: [<%= @title.id %>]
                },
                success: function (data) {
                    response(data)
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    window.location.replace(jqXHR.url)
                }
            });
        },
        focus: function (event, ui) {
            ajaxTitleSummary(ui.item['value']);
            return false;
        },
        select: function (event, ui) {
            toggleTitleSum();
            $(this).val(ui.item['label']);
            $(this).attr('value', ui.item['label']);
            $(this).attr('title_id', ui.item['value']);
            showCgButton($(this));
            return false;
        }
    }).focusout(function () {
        toggleTitleSum();
    }).focusin(function() {
        if ($(this).val().length > 0) {
            $(this).val('');
            $(this).attr('value', '');
            $(this).attr('title_id', null);
            hideCgButton($(this))
        }
    });
  });

  function ajaxTitleSummary(id) {
      $.ajax({
          url: '../../titles/ajax/' + id,
          error: function(jqXHR, textStatus, errorThrown) {
              window.location.replace(jqXHR.url)
          },
          success: function (result) {
              $('#title_sum').html(result).show();
          }
      })
  }

  function toggleTitleSum() {
      $('#title_sum').hide().html('');
  }

  function showCgButton(jq) {
      jq.parent().parent().find(".cg_button").show();
  }
  function hideCgButton(jq) {
      jq.parent().parent().find(".cg_button").hide();
  }
</script>