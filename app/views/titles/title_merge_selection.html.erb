<h4>Title Merge</h4>
<div id="title_selection">
<table>
	<tr>
		<th>Title</th>
		<td>
			<%= text_field_tag :title_text %>
		</td>
	</tr>
</table>
</div>
<div id="title_summary" class="left _75 ml_10" >

</div>
<%= form_tag title_autocomplete_selection_merge_path, id: 'title_autocomplete_select_form' do %>
	<%= hidden_field_tag :master_title_id %>
	<%= hidden_field_tag :mergees %>
	<%= hidden_field_tag :cg_pos %>
	<div id="selected_titles" class="clear">
		<h4 class="m_top_10px">Titles To Merge</h4>
		<p class="warning">Click to select the master Title record - all other titles will be merged into this record</p>
		<table id="title_table">
			<tr>
				<th>Title</th>
				<th>In Active Workflow</th>
				<th>Original Identifiers</th>
				<th>Creators</th>
				<th>Publishers</th>
				<th>Dates</th>
				<th>Summary</th>
				<th>Notes</th>
				<th>Subject</th>
				<th>Name Authority</th>
				<th></th>
			</tr>
		</table>
	</div>
	<div id="physical_objects">

	</div>
	<%= submit_tag 'Merge Titles' %>
<% end %>
<script type="text/javascript" charset="utf-8">
	$(document).ready(function() {
		$('#title_text').focus(function() {
			if ($(this).data('autocomplete')) {
				$(this).autocomplete("destroy");
				$(this).removeData("autocomplete");
				clearTitleSummary();
			}
			$(this).autocomplete({
				minLength: 2,
				//source: '<%= autocomplete_title_path %>',
				source: function(request, response) {
					$.ajax({
						url: "<%= autocomplete_title_path %>",
						dataType: "json",
						data: {
							term: request.term,
							exclude: selectedTitleIds()
						},
						success: function(data) {
							response(data)
						},
            error: function(jqXHR, textStatus, errorThrown) {
                window.location.replace(jqXHR.url)
            }
					});
				},
				focus: function (event, ui) {
					ajaxTitleSummary(ui.item['value'])
					return false;
				},
				select: function (event, ui) {
					clearTitleSummary();
					addTitle(ui.item['value']);
					return false;
				}
			});
		}).focusout(function() {
			clearTitleSummary();
		});


		$('#title_autocomplete_select_form').submit(function(event) {
			event.preventDefault();
			m_id = $('#master_title_id').attr('value');
			pos = getPoIds()
			if (m_id == null || m_id.length == 0) {
				swal('Select a Master Title', 'You must select a master title to merge. Click the row of the title you wish to be the master record. All metadata from other titles will be merged into this record' )
			} else if (pos.length == 0) {
				swal({
					title: 'No Component Group',
					text: ' No physical objects are selected. All physical objects for all titles will be returned to storage. Do you wish to continue?',
					type: 'warning',
					showCancelButton: true,
					confirmButtonText: 'Return all to storage'
				},
				function() {
					document.getElementById('title_autocomplete_select_form').submit();
				});
			} else {
				document.getElementById('title_autocomplete_select_form').submit();
			}
		})
	})

	function addTitle(id) {
		$.ajax({
			url: '/title_merge_selection_table_row/'+id,
			error: function(jqXHR, textStatus, errorThrown) {
          window.location.replace(jqXHR.url)
      },
			success: function(result) {
				$('.title_merge_remove').unbind('click.title_merge_remove_title')
				$('#title_table').append(result)
				$('.title_merge_remove').bind('click.title_merge_remove_title', function(event) {
					var id = $(this).parent().parent().attr('id');
					$(this).parent().parent().remove();
					if (id == $('#master_title_id').attr(('value'))) {
						$('#master_title_id').attr('value', null)
					}
					showPhysicalObjects();
					initTitleSelect();
				});
				initTitleSelect();
				showPhysicalObjects();
			}
		})
	}

	function ajaxTitleSummary(id) {
		$.ajax({
			url: '/titles/ajax/'+id,
			error: function(jqXHR, textStatus, errorThrown) {
          window.location.replace(jqXHR.url)
      },
			success: function(result) {
				$('#title_summary').html(result);
				$('#title_summary').show();
			}
		})
	}

	function showPhysicalObjects() {
		$.ajax({
			url: "<%= title_merge_physical_object_candidates_path %>",
			data: {ids: selectedTitleIds()},
			error: function(jqXHR, textStatus, errorThrown) {
          window.location.replace(jqXHR.url)
      },
			success: function(result) {
				$('#physical_objects').html(result)
				$('.po_check').click(function() {
					var pos = []
					$('.po_check:checked').each(function() {
						pos.push($(this).attr('id').substring(3))
					})
					$('#cg_pos').attr('value', pos.join())
				});
			}
		})
	}
	function clearTitleSummary() {
		$('#title_summary').hide();
		$('#title_summary').html('');
	}

	function selectedTitleIds(includeMaster=true) {
		var vals = [];
		var sel = (includeMaster ? $('.title_row') : $('.title_row').not('.master_selection'));
		sel.each(function() {
			vals.push($(this).attr('id'))
		});
		return vals
	}

	function initTitleSelect() {
		// remove the event handlers as we don't want to double up on them everytime a new row is added/removed
		el = $('#title_table > tbody > tr');
    el.off("click.title_select");
		el.on('click.title_select', function() {
			if ($(this).hasClass('master_selection')) {
				$(this).removeClass('master_selection');
				$('#master_title_id').attr('value', null)
			} else {
				$('.master_selection').removeClass('master_selection');
				$(this).addClass('master_selection');
				$('#master_title_id').attr('value', $(this).attr('id'))
			};
			setHiddenTitleIds();
		});
		setHiddenTitleIds();
	}
	function setHiddenTitleIds() {
		tids = selectedTitleIds(false);
		$('#mergees').attr('value', tids.join(','))
	}
	function getPoIds() {
		var pos = [];
		$('.po_check:checked').each(function() {
			pos.push($(this).attr('id').substring(3))
		});
		return pos
	}
</script>